<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Processus syst√®me</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; padding:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:canvas; color:canvastext; }
    .card { max-width:1600px; margin:0 auto 16px; padding:16px 20px; border:1px solid color-mix(in oklab, canvastext 15%, transparent); border-radius:16px; background:color-mix(in oklab, canvas 92%, canvastext 0%); box-shadow:0 1px 8px color-mix(in oklab, canvastext 10%, transparent); }
    h1 { margin:0 0 8px; font-size:1.25rem; }
    .muted { opacity:.75; font-size:.9rem; }
    table { width:100%; border-collapse:collapse; table-layout:fixed; }
    th, td { padding:10px 12px; border-bottom:1px solid color-mix(in oklab, canvastext 12%, transparent); text-align:left; vertical-align:top; }
    .col-pid { width:70px; }
    .col-nom { width:140px; }
    .col-statut { width:90px; }
    .col-user { width:120px; }
    .col-threads { width:80px; }
    .col-rss { width:90px; }
    .col-vms { width:90px; }
    .col-cree { width:150px; }
    .col-action { width:80px; }
    .col-cmdline { width:400px; max-width:400px; overflow-x:auto; overflow-y:hidden; white-space:nowrap; }
    .col-cmdline::-webkit-scrollbar { height:6px; }
    .col-cmdline::-webkit-scrollbar-track { background:color-mix(in oklab, canvas 90%, canvastext 0%); border-radius:3px; }
    .col-cmdline::-webkit-scrollbar-thumb { background:color-mix(in oklab, canvastext 30%, transparent); border-radius:3px; }
    .col-cmdline::-webkit-scrollbar-thumb:hover { background:color-mix(in oklab, canvastext 40%, transparent); }
    th { font-weight:600; }
    .right { text-align:right; }
    .mono { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.9rem; }
    .nowrap { white-space:nowrap; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type="text"], select { padding:6px 8px; border-radius:10px; border:1px solid color-mix(in oklab, canvastext 25%, transparent); background: color-mix(in oklab, canvas 95%, canvastext 0%); color:inherit; }
    .pill { display:inline-block; padding:.1rem .45rem; border-radius:.75rem; border:1px solid color-mix(in oklab, canvastext 25%, transparent); font-size:.85rem; }
    .btn { padding:6px 10px; border-radius:10px; border:1px solid color-mix(in oklab, dodgerblue 40%, transparent); background: color-mix(in oklab, dodgerblue 35%, canvas); color:white; cursor:pointer; }
    .btn[disabled]{ opacity:.6; cursor:default; }
    .btn-danger { background: color-mix(in oklab, red 35%, canvas); border-color: color-mix(in oklab, red 40%, transparent); }
    .btn-danger:hover { background: color-mix(in oklab, red 45%, canvas); }
    .btn-small { padding:3px 8px; font-size:.8rem; }
  </style>
</head>
<body>

  <section class="card">
    <h1>Processus syst√®me</h1>
    <div class="muted">Source : <code>/procs</code> ‚Äî colonnes : PID, Nom, Statut, Utilisateur, Threads, M√©moire (RSS/VMS), Cr√©√©, Cmdline</div>
    <div class="toolbar" style="margin-top:8px">
      <a href="/html/index" class="btn" style="text-decoration:none">üè† Accueil</a>
      <label>Agent : <select id="agent-select"><option value="">Chargement...</option></select></label>
      <label>Filtrer : <input id="q" type="text" placeholder="nom, utilisateur, cmdline‚Ä¶"></label>
      <label>Statut :
        <select id="status">
          <option value="">(tous)</option>
          <option value="R">R (running)</option>
          <option value="S">S (sleeping)</option>
          <option value="I">I (idle)</option>
          <option value="D">D (uninterruptible)</option>
          <option value="T">T (stopped)</option>
          <option value="Z">Z (zombie)</option>
        </select>
      </label>
      <button id="refresh" class="btn" type="button">Rafra√Æchir</button>
      <span id="count" class="pill">0 √©l√©ments</span>
      <span id="ts" class="muted"></span>
    </div>
  </section>

  <section class="card">
    <table>
      <thead>
        <tr>
          <th class="right col-pid">PID</th>
          <th class="col-nom">Nom</th>
          <th class="col-statut">Statut</th>
          <th class="col-user">Utilisateur</th>
          <th class="right col-threads">Threads</th>
          <th class="right col-rss">RSS</th>
          <th class="right col-vms">VMS</th>
          <th class="nowrap col-cree">Cr√©√©</th>
          <th class="col-cmdline">Cmdline</th>
          <th class="col-action">Action</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="10" class="muted">Chargement‚Ä¶</td></tr>
      </tbody>
    </table>
  </section>

  <script>
    function esc(s) {
      return String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function fmtBytes(n) {
      n = Number(n)||0;
      var units = ['B','KiB','MiB','GiB','TiB'];
      var i = 0;
      while (n >= 1024 && i < units.length-1) { n /= 1024; i++; }
      return n.toFixed(n<10?2: n<100?1:0) + ' ' + units[i];
    }
    function fmtTimeMs(ms) {
      var d = new Date(Number(ms)||0);
      if (!ms) return '';
      return d.toLocaleString();
    }
    function renderRows(items, q, st) {
      if (!Array.isArray(items) || items.length === 0) {
        return '<tr><td colspan="10" class="muted">Aucune donn√©e</td></tr>';
      }
      q = (q||'').toLowerCase();
      var out = [];
      for (var i=0;i<items.length;i++) {
        var x = items[i]||{};
        var hay = (x.name||'')+' '+(x.username||'')+' '+(x.cmdline||'');
        if (q && hay.toLowerCase().indexOf(q) === -1) continue;
        if (st && (x.status||'') !== st) continue;

        out.push(
          '<tr>'
          + '<td class="right mono col-pid">' + esc(x.pid) + '</td>'
          + '<td class="mono col-nom">' + esc(x.name||'') + '</td>'
          + '<td class="nowrap col-statut"><span class="pill">' + esc(x.status||'') + '</span></td>'
          + '<td class="col-user">' + esc(x.username||'') + '</td>'
          + '<td class="right mono col-threads">' + esc(x.threads||'') + '</td>'
          + '<td class="right mono col-rss">' + esc(fmtBytes(x.memory_rss)) + '</td>'
          + '<td class="right mono col-vms">' + esc(fmtBytes(x.memory_vms)) + '</td>'
          + '<td class="nowrap mono col-cree">' + esc(fmtTimeMs(x.create_time)) + '</td>'
          + '<td class="mono col-cmdline">' + esc(x.cmdline||'') + '</td>'
          + '<td class="col-action"><button class="btn btn-danger btn-small" onclick="killProcess(' + esc(x.pid) + ')" title="Tuer le processus">Kill</button></td>'
          + '</tr>'
        );
      }
      if (out.length === 0) {
        return '<tr><td colspan="10" class="muted">Aucun processus ne correspond aux filtres</td></tr>';
      }
      document.getElementById('count').textContent = out.length + ' √©l√©ments';
      return out.join('');
    }

    var DATA = [];
    var AGENTS = [];

    async function loadAgents() {
      try {
        var res = await fetch('/api/agents', {headers:{'Accept':'application/json'}});
        if (!res.ok) throw new Error('HTTP ' + res.status);
        AGENTS = await res.json();
        
        var select = document.getElementById('agent-select');
        select.innerHTML = '';
        
        AGENTS.forEach(function(agent) {
          if (agent.status === 'online') {
            var option = document.createElement('option');
            option.value = agent.host;
            option.textContent = agent.host;
            select.appendChild(option);
          }
        });
        
        if (select.children.length === 0) {
          select.innerHTML = '<option value="">Aucun agent disponible</option>';
        } else {
          select.value = select.children[0].value;
          await load();
        }
      } catch (e) {
        document.getElementById('agent-select').innerHTML = '<option value="">Erreur de chargement</option>';
      }
    }

    async function load() {
      var body = document.getElementById('tbody');
      var selectedAgent = document.getElementById('agent-select').value;
      
      if (!selectedAgent) {
        body.innerHTML = '<tr><td colspan="9" class="muted">S√©lectionnez un agent</td></tr>';
        return;
      }
      
      try {
        var res = await fetch('/api/agent/data?host=' + encodeURIComponent(selectedAgent) + '&endpoint=procs', {
          headers:{'Accept':'application/json'}
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        DATA = await res.json();
        applyFilters();
        document.getElementById('ts').textContent = 'Mis √† jour : ' + new Date().toLocaleTimeString();
      } catch (e) {
        body.innerHTML = '<tr><td colspan="10" class="muted">Erreur: ' + esc(e.message) + '</td></tr>';
      }
    }

    async function killProcess(pid) {
      var selectedAgent = document.getElementById('agent-select').value;
      
      if (!selectedAgent) {
        alert('Veuillez s√©lectionner un agent');
        return;
      }
      
      if (!confirm('Voulez-vous vraiment tuer le processus ' + pid + ' ?')) {
        return;
      }
      
      try {
        var res = await fetch('http://' + selectedAgent + '/procs/kill/' + pid, {
          method: 'GET'
        });
        
        if (res.ok) {
          alert('Processus ' + pid + ' tu√© avec succ√®s');
          await load(); // Recharger la liste
        } else {
          alert('Erreur lors de l\'arr√™t du processus: HTTP ' + res.status);
        }
      } catch (e) {
        alert('Erreur de connexion: ' + e.message);
      }
    }

    function applyFilters() {
      var q = document.getElementById('q').value;
      var st = document.getElementById('status').value;
      document.getElementById('tbody').innerHTML = renderRows(DATA, q, st);
    }

    // Filtres live
    document.getElementById('q').addEventListener('input', applyFilters);
    document.getElementById('status').addEventListener('change', applyFilters);
    document.getElementById('agent-select').addEventListener('change', load);

    // Bouton Rafra√Æchir
    document.getElementById('refresh').addEventListener('click', async function(){
      var btn = this;
      var prev = btn.textContent;
      btn.disabled = true;
      btn.textContent = '‚Ä¶';
      try { await load(); }
      finally { btn.disabled = false; btn.textContent = prev; }
    });

    // Premi√®re charge
    loadAgents();

  </script>

</body>
</html>
