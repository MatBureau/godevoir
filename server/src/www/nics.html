<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>D√©bits r√©seau (temps r√©el)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; padding:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:canvas; color:canvastext; }
    .card { max-width:980px; margin:0 auto 16px; padding:16px 20px; border:1px solid color-mix(in oklab, canvastext 15%, transparent); border-radius:16px; background:color-mix(in oklab, canvas 92%, canvastext 0%); box-shadow:0 1px 8px color-mix(in oklab, canvastext 10%, transparent); }
    h1 { margin:0 0 8px; font-size:1.25rem; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px 10px; border-bottom:1px solid color-mix(in oklab, canvastext 12%, transparent); text-align:left; }
    th { font-weight:600; }
    .muted { opacity:.75; font-size:.9rem; }
    .badge { display:inline-block; padding:.15rem .45rem; border-radius:.5rem; border:1px solid color-mix(in oklab, canvastext 25%, transparent); }
    .addr { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.9rem; }
    .right { text-align:right; }
    .small { font-size:.9rem; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    select { padding:6px 8px; border-radius:10px; border:1px solid color-mix(in oklab, canvastext 25%, transparent); background: color-mix(in oklab, canvas 95%, canvastext 0%); color:inherit; }
    .btn { padding:6px 10px; border-radius:10px; border:1px solid color-mix(in oklab, dodgerblue 40%, transparent); background: color-mix(in oklab, dodgerblue 35%, canvas); color:white; cursor:pointer; }
    .btn[disabled]{ opacity:.6; cursor:default; }
  </style>
</head>
<body>

  <section class="card">
    <h1>Interfaces r√©seau actives (non-loopback)</h1>
    <div class="muted">Source : <code>/nics</code> ‚Äî rafra√Æchissement toutes les 2 secondes ¬∑ valeurs moyenn√©es sur ~1 s</div>
    <div class="toolbar" style="margin-top:8px">
      <a href="/html/index" class="btn" style="text-decoration:none">üè† Accueil</a>
      <label>Agent : <select id="agent-select"><option value="">Chargement...</option></select></label>
      <button id="refresh" class="btn" type="button">Rafra√Æchir</button>
      <span id="ts" class="muted"></span>
    </div>
  </section>

  <section class="card">
    <table>
      <thead>
        <tr>
          <th>Interface</th>
          <th>Adresses</th>
          <th class="right">Rx (Mb/s)</th>
          <th class="right">Tx (Mb/s)</th>
          <th class="right small">MTU</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="5" class="muted">Chargement‚Ä¶</td></tr>
      </tbody>
    </table>
  </section>

  <script>
    var DATA = [];
    var AGENTS = [];

    async function loadAgents() {
      try {
        var res = await fetch('/api/agents', {headers:{'Accept':'application/json'}});
        if (!res.ok) throw new Error('HTTP ' + res.status);
        AGENTS = await res.json();
        
        var select = document.getElementById('agent-select');
        select.innerHTML = '';
        
        AGENTS.forEach(function(agent) {
          if (agent.status === 'online') {
            var option = document.createElement('option');
            option.value = agent.host;
            option.textContent = agent.host;
            select.appendChild(option);
          }
        });
        
        if (select.children.length === 0) {
          select.innerHTML = '<option value="">Aucun agent disponible</option>';
        } else {
          select.value = select.children[0].value;
          await load();
        }
      } catch (e) {
        document.getElementById('agent-select').innerHTML = '<option value="">Erreur de chargement</option>';
      }
    }

    async function load() {
      const body = document.getElementById('tbody');
      var selectedAgent = document.getElementById('agent-select').value;
      
      if (!selectedAgent) {
        body.innerHTML = '<tr><td colspan="5" class="muted">S√©lectionnez un agent</td></tr>';
        return;
      }
      
      try {
        var res = await fetch('/api/agent/data?host=' + encodeURIComponent(selectedAgent) + '&endpoint=nics', {
          headers:{'Accept':'application/json'}
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          body.innerHTML = '<tr><td colspan="5" class="muted">Aucune interface active</td></tr>';
          return;
        }

        body.innerHTML = data.map(function(n) {
          var addrs = (n.addr || []).map(function(a) {
            return '<span class="addr">' + a + '</span>';
          }).join('<br>');

          return '<tr>'
            + '<td><span class="badge">' + n.name + '</span></td>'
            + '<td>' + addrs + '</td>'
            + '<td class="right">' + ((n.rx_mbps || 0).toFixed(3)) + '</td>'
            + '<td class="right">' + ((n.tx_mbps || 0).toFixed(3)) + '</td>'
            + '<td class="right small">' + (n.mtu || '') + '</td>'
            + '</tr>';
        }).join('');
        document.getElementById('ts').textContent = 'Mis √† jour : ' + new Date().toLocaleTimeString();
      } catch (e) {
        body.innerHTML = '<tr><td colspan="5" class="muted">Erreur: ' + e.message + '</td></tr>';
      }
    }

    document.getElementById('agent-select').addEventListener('change', load);
    document.getElementById('refresh').addEventListener('click', async function(){
      var btn = this, prev = btn.textContent;
      btn.disabled = true; btn.textContent = '‚Ä¶';
      try { await load(); }
      finally { btn.disabled = false; btn.textContent = prev; }
    });

    loadAgents();
    setInterval(load, 2000);
  </script>

</body>
</html>
